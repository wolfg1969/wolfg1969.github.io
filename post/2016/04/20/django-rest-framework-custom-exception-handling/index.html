	<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.15" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> 定制 Django REST Framework 的异常处理 &middot; 不上班的程序员 </title>

  
  <link rel="stylesheet" href="http://blog.guoyong.me/css/poole.css">
  <link rel="stylesheet" href="http://blog.guoyong.me/css/syntax.css">
  <link rel="stylesheet" href="http://blog.guoyong.me/css/hyde.css">
  

  
  
  <link rel="shortcut icon" href="http://blog.guoyong.me/favicon.ico">

  
  <link href="" rel="alternate" type="application/rss+xml" title="不上班的程序员" />
</head>

	<body class="theme-base-0b">
		<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://blog.guoyong.me/"><h1>不上班的程序员</h1></a>
      <p class="lead">
       女儿对同学说：“我爸爸的工作是程序员，在家工作。” 
      </p>
      <p><img src="http://blog.guoyong.me/images/qrcode_for_gh_fae8e24dea7a_258.jpg" width="150"></p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="http://blog.guoyong.me/">文章列表</a> </li>
      
    </ul>

    <p> Copyright &#xA9; 2016 wolfg1969. All Rights Reserved.</p>
  </div>
</div>


		<div class="content container">
			<div class="post">
			 	<h1>定制 Django REST Framework 的异常处理</h1>
			  <span class="post-date">Wed, Apr 20, 2016</span>
			      <p>今天借助修复其它 Bug 的机会，对项目中 REST API 的异常处理机制进行了优化。</p>

<p>项目的 REST API 是基于 Django REST Framework 实现的，之前已经按照其文档的说明，对 EXCEPTION_HANDLER 进行了定制，用统一的 JSON 数据格式来输出异常错误信息，包括 500 错误。没有定制时，对于系统所有未特殊处理的异常，Django REST Framework 的处理方法是继续向上抛出，而不是像其它情况那样处理成自己封装的 Exception Response。这样的话，客户端得到的响应是 Django 框架的 500 错误页面，不便于客户端的统一处理。</p>

<p>自定义的异常处理函数如下：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="lineno"> 1 </span><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">exception_handler</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="k">def</span> <span class="nf">my_api_exception_handler</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
<span class="lineno"> 4 </span>    <span class="c1"># Call REST framework&#39;s default exception handler first to get the standard error response.</span>
<span class="lineno"> 5 </span><span class="hll">    <span class="n">response</span> <span class="o">=</span> <span class="n">exception_handler</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</span><span class="lineno"> 6 </span>
<span class="lineno"> 7 </span>    <span class="c1"># handle 500 errors</span>
<span class="lineno"> 8 </span><span class="hll">    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="lineno"> 9 </span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">APIException</span><span class="p">):</span>
<span class="lineno">10 </span>            <span class="n">detail</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">detail</span>
<span class="lineno">11 </span>        <span class="k">else</span><span class="p">:</span>
<span class="lineno">12 </span>            <span class="n">detail</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">message</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">else</span> <span class="s1">&#39;Internal Server Error&#39;</span>
<span class="lineno">13 </span><span class="hll">        <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;detail&#39;</span><span class="p">:</span> <span class="n">detail</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>
</span><span class="lineno">14 </span>
<span class="lineno">15 </span>    <span class="k">return</span> <span class="n">response</span>
<span class="lineno">16 </span>    
</code></pre></div>


<p>这里先调用框架默认的异常处理函数（Line 5），当这个函数返回的 response 对象为 None 时（Line 8），说明异常没有被它处理。这时我们就自己生成一个 status 状态码为 500 的 Response 对象（Line 13），而不是返回 None 。</p>

<p>自定义的异常处理函数必须在 settings 里启用，如下</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;EXCEPTION_HANDLER&#39;</span><span class="p">:</span> <span class="s1">&#39;my_project.my_app.utils. my_api_exception_handler&#39;</span>
<span class="p">}</span>
</code></pre></div>

<p>今天的改进是对异常处理函数中日志的改进。原来的日志记录在发生 500 的错误，就记录一条 Error 日志：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;api view 500 error: </span><span class="si">%s</span><span class="s2"> &gt;&gt;&gt;</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
</code></pre></div>

<p>在生产环境下，这条日志会产生一封通知邮件，但效果并不好，异常堆栈变成了一长串字符被塞进了邮件的主题里，也没有当前 Request 的上下文信息，很难从中分析定位错误。</p>

<p>改进后的日志语句被挪到了 APIView 的 handle_exception 方法里：
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="lineno"> 1 </span><span class="k">def</span> <span class="nf">handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
<span class="lineno"> 2 </span>    <span class="n">resp</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GenericAPIView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
<span class="lineno"> 3 </span>    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">:</span>
<span class="lineno"> 4 </span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;API View 500 error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
<span class="lineno"> 5 </span><span class="hll">                     <span class="n">exc_info</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">(),</span>
</span><span class="lineno"> 6 </span>                     <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<span class="lineno"> 7 </span>                         <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
<span class="lineno"> 8 </span><span class="hll">                         <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span>
</span><span class="lineno"> 9 </span>                     <span class="p">})</span>
<span class="lineno">10 </span>    <span class="k">return</span> <span class="n">resp</span>
<span class="lineno">11 </span>    
</code></pre></div>

可以看到，异常信息和当前请求信息都被记录了（ Line 5 和 Line 8）。exc_info 和 extra 参数的说明见 Python 标准库文档，这里也参考了 Django 中 AdminEmailHandler 类的实现。</p>

<p>以上。</p>

			</div>

			
		</div>

  </body>
</html>
